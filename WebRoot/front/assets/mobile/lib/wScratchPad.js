/******************************************
 * Websanova.com
 *
 * Resources for web entrepreneurs
 *
 * @author          Websanova
 * @copyright       Copyright (c) 2012 Websanova.
 * @license         This wScratchPad jQuery plug-in is dual licensed under the MIT and GPL licenses.
 * @link            http://www.websanova.com
 * @github      http://github.com/websanova/wScratchPad
 * @version         Version 1.4.4
 *
 ******************************************/
!function(t){function e(t,e){return this.sp=null,this.settings=t,this.$elem=e,this.enabled=!0,this.scratch=!1,this.canvas=null,this.ctx=null,this}t.fn.wScratchPad=function(n,i){if("object"==typeof n)i=n;else if("string"==typeof n){var s=[],r=this.each(function(){var e=t(this).data("_wScratchPad");e&&("reset"===n?e.reset():"clear"===n?e.clear():"enabled"===n?e.enabled=i===!0:void 0!==t.fn.wScratchPad.defaultSettings[n]&&(void 0!==i?e.settings[n]=i:s.push(e.settings[n])))});return 1===s.length?s[0]:s.length>0?s:r}return i=t.extend({},t.fn.wScratchPad.defaultSettings,i||{}),this.each(function(){var n=t(this),s=jQuery.extend(!0,{},i),r=document.createElement("canvas");if(!r.getContext)return n.html("Browser does not support HTML5 canvas, please upgrade to a more modern browser."),!1;var o=new e(s,n);n.append(o.generate()),o.pixels=o.canvas.width*o.canvas.height,n.data("_wScratchPad",o),o.init()})},t.fn.wScratchPad.defaultSettings={width:210,height:100,image:"images/slide1.jpg",image2:null,color:"#336699",overlay:"none",size:10,realtimePercent:!1,scratchDown:null,scratchUp:null,scratchMove:null,cursor:null},e.prototype={generate:function(){var e=this;return this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.sp=t("<div></div>").css({position:"relative"}).append(t(this.canvas).attr("width",this.settings.width+"px").attr("height",this.settings.height+"px")),t(this.canvas).mousedown(function(n){return e.enabled?(n.preventDefault(),n.stopPropagation(),e.canvas_offset=t(e.canvas).offset(),e.scratch=!0,void e.scratchFunc(n,e,"Down")):!0}).mousemove(function(t){t.preventDefault(),t.stopPropagation(),e.scratch&&e.scratchFunc(t,e,"Move")}).mouseup(function(t){t.preventDefault(),t.stopPropagation(),e.scratch&&(e.scratch=!1,e.scratchFunc(t,e,"Up"))}),this.bindMobile(this.sp),this.sp},bindMobile:function(t){t.bind("touchstart touchmove touchend touchcancel",function(){var t=event.changedTouches,e=t[0],n="";switch(event.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break;default:return}var i=document.createEvent("MouseEvent");i.initMouseEvent(n,!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(i),event.preventDefault()})},init:function(){this.sp.css("width",this.settings.width),this.sp.css("height",this.settings.height),this.sp.css("cursor",this.settings.cursor?'url("'+this.settings.cursor+'"), default':"default"),this.sp.css("background-img","none"),t(this.canvas).css({cursor:this.settings.cursor?'url("'+this.settings.cursor+'"), default':"default"}),this.canvas.width=this.settings.width,this.canvas.height=this.settings.height,this.pixels=this.canvas.width*this.canvas.height,this.settings.image2?this.drawImage(this.settings.image2):("none"!=this.settings.overlay?(this.settings.image&&this.drawImage(this.settings.image),this.ctx.globalCompositeOperation=this.settings.overlay):this.setBgImage(),this.ctx.fillStyle=this.settings.color,this.ctx.beginPath(),this.ctx.rect(0,0,this.settings.width,this.settings.height),this.ctx.fill())},reset:function(){this.ctx.globalCompositeOperation="source-over",this.init()},clear:function(){this.ctx.clearRect(0,0,this.settings.width,this.settings.height)},setBgImage:function(){this.settings.image&&this.sp.css({backgroundImage:"url("+this.settings.image+")",backgroundSize:"100% 100%",backgroundRepeat:"no-repeat"})},drawImage:function(e){var n=this,i=new Image;i.src=e,t(i).load(function(){n.ctx.drawImage(i,0,0,n.settings.width,n.settings.height),n.setBgImage()})},scratchFunc:function(t,e,n){t.pageX=Math.floor(t.pageX-e.canvas_offset.left),t.pageY=Math.floor(t.pageY-e.canvas_offset.top),e["scratch"+n](t,e),(this.settings.realtimePercent||"Up"==n)&&e.settings["scratch"+n]&&e.settings["scratch"+n].apply(e,[t,e.scratchPercentage(e)])},scratchPercentage:function(t){for(var e=0,n=t.ctx.getImageData(0,0,t.canvas.width,t.canvas.height),i=0,s=n.data.length;s>i;i+=4)0==n.data[i]&&0==n.data[i+1]&&0==n.data[i+2]&&0==n.data[i+3]&&e++;return e/t.pixels*100},scratchDown:function(t,e){e.ctx.globalCompositeOperation="destination-out",e.ctx.lineJoin="round",e.ctx.lineCap="round",e.ctx.strokeStyle=e.settings.color,e.ctx.lineWidth=e.settings.size,e.ctx.beginPath(),e.ctx.arc(t.pageX,t.pageY,e.settings.size/2,0,2*Math.PI,!0),e.ctx.closePath(),e.ctx.fill(),e.ctx.beginPath(),e.ctx.moveTo(t.pageX,t.pageY)},scratchMove:function(t,e){e.ctx.lineTo(t.pageX,t.pageY),e.ctx.stroke()},scratchUp:function(t,e){e.ctx.closePath()}}}(jQuery);